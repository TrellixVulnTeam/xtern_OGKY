#!/bin/bash

set -e

# if get an error like " cannot find crti.o ..."
# sudo ln -s /usr/lib/x86_64-linux-gnu /usr/lib64

ROOT=`pwd`

if [ ! -d $XTERN_ROOT ]; then
	echo "XTERN_ROOT is not defined"
	exit 1
fi

if [ ! -d $APPS_DIR ]; then
    echo "APPS_DIR is not defined"
    exit 1
fi

PARSEC_ROOT=$XTERN_ROOT/apps/parsec

SOURCE=$PARSEC_ROOT/gcc-4.2-src/
INSTALL=$PARSEC_ROOT/gcc-4.2/

rm -rf $SOURCE $INSTALL

pushd $PARSEC_ROOT

tar zxf $APPS_DIR/sys/gcc-4.2.4.tar.gz
mv gcc-4.2.4 $SOURCE

pushd $SOURCE

patch -p1 < ../patch/xtern_annot.patch
XTERN_ANNOT_LIB="-I$XTERN_ROOT/include -L$XTERN_ROOT/dync_hook -Wl,--rpath,$XTERN_ROOT/dync_hook -lxtern-annot"
CFLAGS+="$XTERN_ANNOT_LIB" ./configure --prefix=$INSTALL --disable-linux-futex --enable-languages=c,c++ --disable-multilib
make -j64
mkdir -p $INSTALL
make -j64 install

#rm -rf $INSTALL/lib64/libstdc++.so
#rm -rf $INSTALL/lib64/libstdc++.so.6
#ln -s /usr/lib/x86_64-linux-gnu/libstdc++.so.6 $INSTALL/lib64/libstdc++.so
#ln -s /usr/lib/x86_64-linux-gnu/libstdc++.so.6 $INSTALL/lib64/libstdc++.so.6

popd
popd
