#!/bin/bash

set -e

if [ ! -d $XTERN_ROOT ]; then
    echo "XTERN_ROOT is not defined"
    exit 1
fi

if [ ! -d $APPS_DIR ]; then
	echo '$APPS_DIR not defined, do `export APPS_DIR=`'
	exit 1
fi

VER=6.8.0-4

echo -e "\nPlease make sure you have run the 'mk' in $XTERN_ROOT/apps/openmp before you build imagick.\n"
sleep 1

# cleanup
cd $XTERN_ROOT/apps/openmp/imagick
rm -rf ImageMagick-$VER install
tar zxf $APPS_DIR/sys/ImageMagick-$VER.tar.gz

# extract images
tar zxf $APPS_DIR/sys/openmp_img.gz

# patch ImageMagick
cd ImageMagick-$VER
patch -p1 < ../add-convert-xtern-annot.patch
patch -p1 < ../add-resize-xtern-annot.patch
patch -p1 < ../add-compare-xtern-annot.patch
patch -p1 < ../add-draw-xtern-annot.patch
patch -p1 < ../add-colorspace-xtern-annot.patch
patch -p1 < ../add-fx-xtern-annot.patch
patch -p1 < ../add-morph-xtern-annot.patch
patch -p1 < ../add-shear-xtern-annot.patch

# compile ImageMagick
mkdir obj
cd obj
CC_HOME=$XTERN_ROOT/apps/openmp/install

CC="$CC_HOME/bin/gcc" \
  CXX="$CC_HOME/bin/g++" \
  CFLAGS+="-g -O2 -I/usr/include/x86_64-linux-gnu -I$XTERN_ROOT/include -fopenmp" \
  CXXFLAGS+="-g -O2 -I$XTERN_ROOT/include -fopenmp" \
  LDFLAGS+="-L$CC_HOME/lib -Wl,--rpath,$CC_HOME/lib -L$CC_HOME/lib64 -Wl,--rpath,$CC_HOME/lib64 -L$XTERN_ROOT/dync_hook -Wl,--rpath,$XTERN_ROOT/dync_hook " \
  LIBS+="-lgomp -lxtern-annot" \
  ../configure --prefix=$XTERN_ROOT/apps/openmp/imagick/install --disable-shared --enable-static --enable-openmp 2>&1 | tee config.results

make V=1 -j64
make install

# create link
cd ../..
find . -maxdepth 1 -type l -exec rm -rf {} \;
bench=( animate composite convert identify mogrify stream compare conjure display import montage )
for i in "${bench[@]}"
do
    ln -s install/bin/$i
done
